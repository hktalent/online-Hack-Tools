const level = require('level'),request = require('request'),searcher = require('node-ip2region').create(),
    options = {json: true}
// ,qqwry = require('lib-qqwry')();qqwry.speed(); //启用急速模式;

var g_oDb = {};

function getIp(ip,fnCbk,o)
{
    // security check
    if(!/^([0-9]{1,3}\.){3}[0-9]{1,3}$/gmi.test(ip) || '127.0.0.1' == ip || /^192\.168\./gmi.test(ip))return;

    o = o || {"dbName":"ipDb"};
    (g_oDb[o.dbName] = g_oDb[o.dbName] || level(o.dbName)).get(ip,function(err,v)
    {
        if(err)
        {
            // 获取ip归属;qqwry.searchIP(ip)
            v = {"ip":ip};
            // 获取ip 经纬度
            var szUrl = 'http://ip-api.com/json/' + ip;
            // https://api.ip2proxy.com/?key={YOUR_API_KEY}&ip=199.180.115.7&package=PX11&format=json
            request(szUrl, options, (error, res, oRst) => {
                if (!error && res.statusCode == 200) {
                    var a = "status;timezone;query".split(/[;,]/);
                    for(var k in a) {
                        delete oRst[a[k]];
                    }
                    oRst["region"] = searcher.btreeSearchSync(ip)['region'];
                    // 保存ip
                    g_oDb[o.dbName].put(ip,JSON.stringify(oRst));
                    // cbk
                    fnCbk(oRst);
                };
            });
        }
        else fnCbk(JSON.parse(v));
    });
}

function getIps(ips,fnCbk,o)
{
  for(var i in ips)
  {
    getIp(ips[i],fnCbk,o)
  }
}

// test
getIps("103.224.212.220;104.224.169.71;109.68.96.189;111.206.174.2;111.206.174.3;113.96.209.106;127.0.0.1;128.243.40.39;139.162.62.29;143.110.237.93;154.73.34.8;158.69.221.198;158.69.57.20;165.22.184.106;17.253.116.253;17.57.146.37;176.62.31.10;178.210.92.7;18.191.223.12;185.125.180.70;185.140.24.140;185.39.86.17;185.45.152.22;185.61.119.19;192.168.0.101;192.168.0.102;192.168.0.103;192.168.0.107;192.168.0.109;192.168.1.13;192.168.1.21;193.22.119.20;193.28.184.4;193.43.148.37;194.87.0.22;195.254.254.20;195.35.114.37;195.35.115.37;198.41.30.195;198.41.30.198;198.41.30.199;199.180.115.7;206.53.159.130;206.53.159.134;208.83.246.100;208.83.61.2;212.227.67.33;212.227.67.34;212.230.32.233;212.53.40.40;213.140.209.236;213.251.48.147;216.93.246.18;217.0.12.17;217.0.136.1;217.0.136.17;217.10.68.145;217.10.68.152;217.27.116.193;217.27.116.195;217.74.179.29;23.253.102.137;40.77.226.250;42.121.15.99;45.15.102.31;45.32.217.190;46.193.255.81;51.38.45.26;52.76.91.67;54.247.91.34;54.37.20.144;54.39.182.217;62.96.96.137;64.131.63.216;64.131.63.217;64.235.150.11;64.235.154.129;66.158.128.6;66.51.128.11;70.42.198.30;70.42.198.34;75.2.81.221;77.72.169.210;77.72.169.211;77.72.169.212;77.72.169.213;78.40.250.221;79.136.2.52;81.187.30.115;82.113.193.63;82.97.157.254;83.125.8.47;83.211.9.232;83.235.24.77;85.17.88.164;85.192.44.73;85.214.134.163;85.93.219.114;91.121.128.132;91.121.209.194;91.121.30.149;91.121.31.8;91.151.52.200;92.222.127.114".split(/[;,]/),function(v)
{
    console.log(v);
});
